// TODO put all this inline code in here somehow?